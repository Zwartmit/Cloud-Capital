// Prisma schema for Cloud Capital database

generator client {
  provider      = "prisma-client-js"
  output        = "../../../node_modules/.prisma/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  SUBADMIN
  SUPERADMIN
}

enum TaskStatus {
  PENDING
  PRE_APPROVED
  PRE_REJECTED
  COMPLETED
  REJECTED
}

enum TaskType {
  DEPOSIT_MANUAL
  DEPOSIT_AUTO
  WITHDRAWAL
  LIQUIDATION
}

enum InvestmentClass {
  BRONCE
  PLATA
  BASIC
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum BtcAddressStatus {
  AVAILABLE  // Disponible para asignar
  RESERVED   // Reservada para un depósito pendiente
  USED       // Ya recibió fondos, archivada
  DELETED    // Eliminada (soft delete)
}

enum AuditAction {
  APPROVED_DEPOSIT
  REJECTED_DEPOSIT
  ADJUSTED_AMOUNT
  UPLOADED_ADDRESSES
  RECYCLED_ADDRESS
  VERIFIED_BLOCKCHAIN
}

model User {
  id                 String           @id @default(uuid())
  email              String           @unique
  password           String
  name               String
  username           String           @unique
  role               UserRole         @default(USER)
  
  capitalUSDT        Float?
  currentBalanceUSDT Float?
  
  investmentClass    InvestmentClass?
  
  referralCode       String?          @unique
  referrerId         String?
  referrer           User?            @relation("UserReferrals", fields: [referrerId], references: [id])
  referrals          User[]           @relation("UserReferrals")
  
  hasFirstDeposit    Boolean          @default(false)
  
  // BTC Wallet Addresses
  btcDepositAddress  String?          @unique  // Dirección BTC para depósitos
  btcWithdrawAddress String?                   // Dirección BTC personal del usuario
  whatsappNumber     String?                   // Número de WhatsApp (para colaboradores)
  collaboratorConfig Json?                     // Configuración específica de colaborador (comisión, tiempo, límites)
  
  // Account Blocking (for liquidation)
  isBlocked          Boolean          @default(false)  // Cuenta bloqueada tras liquidación
  blockedAt          DateTime?                          // Fecha de bloqueo
  blockedReason      String?                            // Razón del bloqueo
  
  // Contract Lifecycle Management (Spec 2, 3, 4, 5)
  contractStatus     String           @default("ACTIVE") // ACTIVE, COMPLETED, PENDING_PLAN_SELECTION, AWAITING_ACTION
  cycleCompleted     Boolean          @default(false)    // Si alcanzó el 200% (2x depósitos)
  cycleCompletedAt   DateTime?                           // Fecha cuando completó el ciclo
  
  // Plan Subscription Tracking (Spec 1)
  currentPlanStartDate   DateTime?                       // Fecha de suscripción al plan actual
  currentPlanExpiryDate  DateTime?                       // Fecha de expiración del plan (30 días)
  lastCommissionChargeDate DateTime?                     // Última vez que se cobró comisión del plan
  
  // Contact Information (for landing page)
  contactEmail       String?                   // Email de contacto público
  contactTelegram    String?                   // Usuario de Telegram para contacto

  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  
  transactions       Transaction[]
  tasks              Task[]
  tasksAsCollaborator Task[]     @relation("TaskCollaborator")
  commissions        ReferralCommission[] @relation("ReferrerCommissions")
  referredCommissions ReferralCommission[] @relation("ReferredUserCommissions")
  collaboratorBankAccounts CollaboratorBankAccount[]
  
  // BTC Address Pool Relations
  btcAddressesUploaded BtcAddressPool[] @relation("AddressUploader")
  btcAddressesUsed     BtcAddressPool[]
  auditLogs            AuditLog[]
  
  @@map("users")
}

model Transaction {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type       String   // "DEPOSIT", "WITHDRAWAL", "PROFIT", "REINVEST"
  amountUSDT Float
  amountBTC  Float?
  btcPrice   Float?
  fee        Float?
  netAmount  Float?
  
  reference  String?  // TXID, wallet address, etc.
  status     String   @default("COMPLETED")
  
  createdAt  DateTime @default(now())
  
  @@map("transactions")
  @@index([userId])
}

model Task {
  id                 String     @id @default(uuid())
  userId             String
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type               TaskType
  status             TaskStatus @default(PENDING)
  
  amountUSD          Float
  reference          String?
  proof              String?    // URL to proof image
  
  approvedByAdmin    String?    // Email of admin who approved
  rejectionReason    String?    // Reason for rejection if status is REJECTED
  
  // BTC Transaction Fields
  btcAddress         String?    // Dirección BTC origen/destino
  txid               String?    // Transaction ID de blockchain
  collaboratorName   String?    // Nombre del colaborador (para DEPOSIT_MANUAL)
  
  // Relation to collaborator (User)
  collaboratorId     String?
  collaborator       User?      @relation("TaskCollaborator", fields: [collaboratorId], references: [id])
  
  depositMethod      String?    // "AUTO" o "MANUAL"
  
  // Withdrawal Fields
  destinationType    String?    // "PERSONAL", "COLLABORATOR"
  destinationUserId  String?    // ID del colaborador (si aplica)
  bankDetails        Json?      // Detalles bancarios para transacciones manuales
  
  liquidationDetails Json?      // For liquidation tasks
  
  collaboratorVerified Boolean    @default(false) // Si el admin verificó que el colaborador envió los fondos
  
  // BTC Address Pool Integration
  assignedAddress     String?   // Dirección asignada desde el pool
  verificationMethod  String?   // "MANUAL_EXPLORER", "API_VERIFIED"
  blockchainData      Json?     // Datos obtenidos de Blockstream API
  adminNotes          String?   @db.Text
  adjustedAmount      Float?    // Monto ajustado por el admin (si difiere del declarado)
  
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  
  @@map("tasks")
  @@index([status])
  @@index([collaboratorId])
}

model InvestmentPlan {
  id                     String   @id @default(uuid())
  name                   String
  minCapital             Float
  minDailyReturn         Float    // Percentage
  maxDailyReturn         Float    // Percentage
  dailyAverage           Float    // Percentage
  monthlyCommission      Float    // Percentage
  referralCommissionRate Float    @default(0.10) // Percentage (0.05 = 5%, 0.10 = 10%)
  doublingTime           String
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("investment_plans")
}

model ReferralCommission {
  id               String   @id @default(uuid())
  
  // Usuario que recibe la comisión (el referidor)
  referrerId       String
  referrer         User     @relation("ReferrerCommissions", fields: [referrerId], references: [id], onDelete: Cascade)
  
  // Usuario que generó la comisión (el referido)
  referredUserId   String
  referredUser     User     @relation("ReferredUserCommissions", fields: [referredUserId], references: [id], onDelete: Cascade)
  
  // Detalles de la comisión
  depositAmount    Float    // Monto del depósito que generó la comisión
  commissionRate   Float    // Tasa aplicada (ej: 0.10 para 10%)
  commissionAmount Float    // Monto pagado
  
  // Trazabilidad
  depositTaskId    String?  // Referencia al Task de depósito
  transactionId    String?  // Referencia a la Transaction creada
  
  createdAt        DateTime @default(now())
  
  @@map("referral_commissions")
  @@index([referrerId])
  @@index([referredUserId])
}

model DailyProfitRate {
  id              String          @id @default(uuid())
  date            DateTime        // We will store midnight UTC used for the day
  investmentClass InvestmentClass
  rate            Float           // Percentage (e.g. 0.8 for 0.8%)
  processed       Boolean         @default(false)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([date, investmentClass])
  @@map("daily_profit_rates")
}

model Bank {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("banks")
}

model BtcAddressPool {
  id                String           @id @default(uuid())
  address           String           @unique
  status            BtcAddressStatus @default(AVAILABLE)
  
  // Tracking de reserva
  reservedAt        DateTime?
  reservedForTaskId String?
  
  // Tracking de uso
  usedAt            DateTime?
  usedByUserId      String?
  usedByUser        User?            @relation(fields: [usedByUserId], references: [id])
  
  // Monto solicitado y notas
  requestedAmount   Decimal?         @db.Decimal(18, 2)
  receivedAmount    Decimal?         @db.Decimal(18, 2)  // Monto realmente recibido en la dirección
  adminNotes        String?          @db.Text
  
  // Soft delete
  deletedAt         DateTime?
  
  // Auditoría de carga
  uploadedBy        String
  uploadedByUser    User             @relation("AddressUploader", fields: [uploadedBy], references: [id])
  uploadedAt        DateTime         @default(now())
  
  // Metadata
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([status])
  @@index([reservedAt])
  @@index([uploadedBy])
  @@map("btc_address_pool")
}

model AuditLog {
  id             String      @id @default(uuid())
  
  // Quién
  adminId        String
  admin          User        @relation(fields: [adminId], references: [id])
  adminEmail     String
  adminRole      UserRole
  
  // Qué
  action         AuditAction
  entityType     String      // "DEPOSIT", "WITHDRAWAL", "ADDRESS"
  entityId       String      // ID del Task, Address, etc.
  
  // Detalles
  oldValue       Json?
  newValue       Json?
  blockchainLink String?     @db.Text
  notes          String?     @db.Text
  
  // Tracking
  ipAddress      String?
  userAgent      String?     @db.Text
  
  createdAt      DateTime    @default(now())
  
  @@index([adminId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model CollaboratorBankAccount {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bankName        String
  accountType     String   // "AHORROS" | "CORRIENTE"
  accountNumber   String
  accountHolder   String
  documentType    String   // "DNI" | "PASAPORTE" | "RUC" | "CEDULA"
  documentNumber  String
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("collaborator_bank_accounts")
}
